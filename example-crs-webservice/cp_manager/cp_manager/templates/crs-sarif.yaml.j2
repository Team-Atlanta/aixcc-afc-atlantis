apiVersion: v1
kind: Pod
metadata:
  name: {{ name }}
  namespace: crs-webservice
  labels:
    app: "crs-sarif"
    task_id: {{ task_id }}
    node_type: {{ node_type }}
    {% if extra_labels %}
    {% for key, value in extra_labels.items() %}
    {{ key }}: {{ value }}
    {% endfor %}
    {% endif %}
spec:
  imagePullSecrets:
  - name: registry-secret
  serviceAccountName: k8s-full-control
  volumes:
    - name: shared-crs-fs-volume
      persistentVolumeClaim:
        claimName: shared-crs-fs
    - name: tarball-fs-volume
      persistentVolumeClaim:
        claimName: tarball-fs
    - name: registry-config
      secret:
        secretName: registry-secret
  restartPolicy: Always
  containers:
    - name: crs-sarif-build-runner
      image: {{ registry }}/crs-sarif/sarif-build-runner:{{image_version}}
      volumeMounts:
        - name: shared-crs-fs-volume
          mountPath: /shared-crs-fs
        - name: tarball-fs-volume
          mountPath: /tarball-fs
        - name: registry-config
          mountPath: /root/.docker/config.json
          subPath: .dockerconfigjson
      securityContext:
        privileged: true
      {% if env_vars %}
      env:
        {% for key, value in env_vars.items() %}
        - name: {{ key }}
          value: "{{ value }}"
        {% endfor %}
      {% endif %}
      {% if resources %}
      resources:
        {{ resources | to_nice_yaml(indent=8) }}
      {% endif %}
    - name: crs-sarif-container
      image: {{ registry }}/crs-sarif/crs-sarif:{{image_version}}
      # command: ["run_crs.sh"]
      volumeMounts:
        - name: shared-crs-fs-volume
          mountPath: /shared-crs-fs
        - name: tarball-fs-volume
          mountPath: /tarball-fs
          readOnly: true
        - name: registry-config
          mountPath: /root/.docker/config.json
          subPath: .dockerconfigjson
      securityContext:
        privileged: true
      {% if env_vars %}
      env:
        {% for key, value in env_vars.items() %}
        - name: {{ key }}
          value: "{{ value }}"
        {% endfor %}
      {% endif %}
      {% if resources %}
      resources:
        {{ resources | to_nice_yaml(indent=8) }}
      {% endif %}
    - name: crs-sarif-redis
      image: redis:6.2-alpine
      command: ['redis-server']
      ports:
      - containerPort: 6379
    - name: crs-sarif-tracer
      {% if env_vars["PROJECT_LANGUAGE"] == "c" %}
      image: {{ registry }}/crs-sarif/sarif-tracer-c:{{image_version}}
      {% else %}
      image: {{ registry }}/crs-sarif/sarif-tracer-java:{{image_version}}
      {% endif %}
      volumeMounts:
        - name: shared-crs-fs-volume
          mountPath: /shared-crs-fs
        - name: tarball-fs-volume
          mountPath: /tarball-fs
          readOnly: true
        - name: registry-config
          mountPath: /root/.docker/config.json
          subPath: .dockerconfigjson
      securityContext:
        privileged: true
      {% if env_vars %}
      env:
        {% for key, value in env_vars.items() %}
        - name: {{ key }}
          value: "{{ value }}"
        {% endfor %}
      {% endif %}
      {% if resources %}
      resources:
        {{ resources | to_nice_yaml(indent=8) }}
      {% endif %}
  {% if node_selector %}
  nodeSelector:
    {{ node_selector | to_nice_yaml(indent=4) }}
  {% endif %}
  {% if tolerations %}
  tolerations:
    {{ tolerations | to_nice_yaml(indent=4) }}
  {% endif %}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ name }}
  namespace: crs-webservice
  labels:
    app: "crs-sarif"
    task_id: {{ task_id }}
    node_type: {{ node_type }}
spec:
  selector:
    app: "crs-sarif"
    task_id: {{ task_id }}
    node_type: {{ node_type }}
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 80
  type: {{ service_type | default("ClusterIP") }}
