FROM ghcr.io/aixcc-finals/base-runner

RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    wget \
    tar \
    python3 \
    python3-pip

RUN python3 -m pip install loguru pydantic 

ENV TRACE_TOOL_DIR=/trace-tool
COPY ./tools $TRACE_TOOL_DIR

ENV TRACER_DYNAMORIO_TOOL_DIR=$TRACE_TOOL_DIR/dynamorio
ENV DYNAMORIO_HOME=$TRACER_DYNAMORIO_TOOL_DIR/DynamoRIO-Linux-11.90.20147
ENV DYNAMORIO_PLUGIN=$TRACER_DYNAMORIO_TOOL_DIR/libfunction_trace.so

RUN cd $TRACER_DYNAMORIO_TOOL_DIR && \
    chmod +x build.sh && \
    ./build.sh


ENV TRACER_PATH=/tracer

COPY ./src $TRACER_PATH

WORKDIR $TRACER_PATH