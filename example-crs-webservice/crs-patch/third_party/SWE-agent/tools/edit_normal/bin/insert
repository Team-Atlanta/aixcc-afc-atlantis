#!/usr/bin/env python3

import argparse
from typing import Union

from windowed_file import FileNotOpened, WindowedFile  # type: ignore

RETRY_WITH_OUTPUT_TOKEN = "###SWE-AGENT-RETRY-WITH-OUTPUT###"


def get_parser() -> argparse.ArgumentParser:
    parser = argparse.ArgumentParser()
    parser.add_argument("text", type=str)
    parser.add_argument("line", type=int, nargs="?", default=None)
    return parser


def main(text: str, line: Union[int, None] = None):
    try:
        wf = WindowedFile(exit_on_exception=False)
    except FileNotOpened:
        print("No file opened. Use the `create` or `open` command first.")
        print(RETRY_WITH_OUTPUT_TOKEN)
        exit(1)

    insert_info = wf.insert(text, line=line - 1 if line is not None else None)

    # Try to filter out pre-existing errors
    replacement_window = (insert_info.first_inserted_line, insert_info.first_inserted_line)

    wf.print_window()


if __name__ == "__main__":
    main(**vars(get_parser().parse_args()))
