2045:void
2046:ngx_http_process_request(ngx_http_request_t *r)
2047:{
2048:    ngx_connection_t  *c;
2049:
2050:    c = r->connection;
2051:
2052:#if (NGX_HTTP_SSL)
2053:
2054:    if (r->http_connection->ssl) {
2055:        long                      rc;
2056:        X509                     *cert;
2057:        const char               *s;
2058:        ngx_http_ssl_srv_conf_t  *sscf;
2059:
2060:        if (c->ssl == NULL) {
2061:            ngx_log_error(NGX_LOG_INFO, c->log, 0,
2062:                          "client sent plain HTTP request to HTTPS port");
2063:            ngx_http_finalize_request(r, NGX_HTTP_TO_HTTPS);
2064:            return;
2065:        }
2066:
2067:        sscf = ngx_http_get_module_srv_conf(r, ngx_http_ssl_module);
2068:
2069:        if (sscf->verify) {
2070:            rc = SSL_get_verify_result(c->ssl->connection);
2071:
2072:            if (rc != X509_V_OK
2073:                && (sscf->verify != 3 || !ngx_ssl_verify_error_optional(rc)))
2074:            {
2075:                ngx_log_error(NGX_LOG_INFO, c->log, 0,
2076:                              "client SSL certificate verify error: (%l:%s)",
2077:                              rc, X509_verify_cert_error_string(rc));
2078:
2079:                ngx_ssl_remove_cached_session(c->ssl->session_ctx,
2080:                                       (SSL_get0_session(c->ssl->connection)));
2081:
2082:                ngx_http_finalize_request(r, NGX_HTTPS_CERT_ERROR);
2083:                return;
2084:            }
2085:
2086:            if (sscf->verify == 1) {
2087:                cert = SSL_get_peer_certificate(c->ssl->connection);
2088:
2089:                if (cert == NULL) {
2090:                    ngx_log_error(NGX_LOG_INFO, c->log, 0,
2091:                                  "client sent no required SSL certificate");
2092:
2093:                    ngx_ssl_remove_cached_session(c->ssl->session_ctx,
2094:                                       (SSL_get0_session(c->ssl->connection)));
2095:
2096:                    ngx_http_finalize_request(r, NGX_HTTPS_NO_CERT);
2097:                    return;
2098:                }
2099:
2100:                X509_free(cert);
2101:            }
2102:
2103:            if (ngx_ssl_ocsp_get_status(c, &s) != NGX_OK) {
2104:                ngx_log_error(NGX_LOG_INFO, c->log, 0,
2105:                              "client SSL certificate verify error: %s", s);
2106:
2107:                ngx_ssl_remove_cached_session(c->ssl->session_ctx,
2108:                                       (SSL_get0_session(c->ssl->connection)));
2109:
2110:                ngx_http_finalize_request(r, NGX_HTTPS_CERT_ERROR);
2111:                return;
2112:            }
2113:        }
2114:    }
2115:
2116:#endif
2117:
2118:    if (c->read->timer_set) {
2119:        ngx_del_timer(c->read);
2120:    }
2121:
2122:#if (NGX_STAT_STUB)
2123:    (void) ngx_atomic_fetch_add(ngx_stat_reading, -1);
2124:    r->stat_reading = 0;
2125:    (void) ngx_atomic_fetch_add(ngx_stat_writing, 1);
2126:    r->stat_writing = 1;
2127:#endif
2128:
2129:    c->read->handler = ngx_http_request_handler;
2130:    c->write->handler = ngx_http_request_handler;
2131:    r->read_event_handler = ngx_http_block_reading;
2132:
2133:    ngx_http_handler(r);
2134:}
