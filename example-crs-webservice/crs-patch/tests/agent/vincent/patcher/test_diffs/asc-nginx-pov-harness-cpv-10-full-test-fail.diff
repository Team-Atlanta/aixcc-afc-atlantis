diff --git a/src/http/modules/ngx_http_userid_filter_module.c b/src/http/modules/ngx_http_userid_filter_module.c
index 07163a0..515599f 100644
--- a/src/http/modules/ngx_http_userid_filter_module.c
+++ b/src/http/modules/ngx_http_userid_filter_module.c
@@ -354,6 +354,13 @@ ngx_http_userid_get_uid(ngx_http_request_t *r, ngx_http_userid_conf_t *conf)
         return ctx;
     }
 
+    if (ctx->cookie.len > 22) {
+        ngx_log_error(NGX_LOG_ERR, r->connection->log, 0,
+                      "client sent too long userid cookie \"%V\"",
+                      &cookie->value);
+        return ctx;
+    }
+
     src = ctx->cookie;
 
     dst.data = (u_char *) ctx->uid_got;
@@ -443,7 +450,13 @@ ngx_http_userid_set_uid(ngx_http_request_t *r, ngx_http_userid_ctx_t *ctx,
         }
 
     } else {
-        p = ngx_cpymem(p, ctx->cookie.data, 22);
+        if (ctx->cookie.len != 22) {
+            ngx_log_error(NGX_LOG_ERR, r->connection->log, 0,
+                         "client sent incorrect userid cookie length: %i",
+                         ctx->cookie.len);
+            return NGX_ERROR;
+        }
+        p = ngx_cpymem(p, ctx->cookie.data, ctx->cookie.len);
         *p++ = conf->mark;
         *p++ = '=';
     }
